<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å –ì–∏–≥–∞—á–∞–¥–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1: #080d1e;
      --bg2: #24113a;
      --accent: #60a5fa;
      --muted: #9aa4b2;
      --panel: #0b1220;
      --glass: rgba(255,255,255,0.03);
      --light-bg1: #fffbe9;
      --light-bg2: #f3f7fa;
      --light-panel: #fff;
      --light-accent: #2563eb;
      --light-muted: #64748b;
    }
    html,body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
      color: #e6eef8;
      min-height: 100vh;
      min-width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      transition: background 0.6s;
      font-size: clamp(13px, 1.1vw, 20px);
      box-sizing: border-box;
      padding-top: 10.4em; /* —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ 20% –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ ~8.4em */
      overflow-x: hidden;
    }
    body.light {
      background: linear-gradient(135deg,var(--light-bg1),var(--light-bg2));
      color: #1e293b;
    }
    .header-controls {
      position: fixed;
      top: 0.7em;
      right: 0.7em;
      z-index: 100;
      display: flex;
      gap: 0.8em;
      background: rgba(20,20,40,0.09);
      border-radius: 2em;
      padding: 0.18em 0.75em;
      box-shadow: 0 1px 6px 0 rgba(60,80,160,0.08);
    }
    @media (max-width:500px){
      .header-controls{top:0.4em;right:0.1em;padding:0.13em 0.4em;}
    }
    .description {
      font-size: 1.04em;
      margin: 0 0 2.1em 0; /* —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ +20% (–±—ã–ª–æ 0.8em, —Ç–µ–ø–µ—Ä—å 2.1em) */
      color: var(--muted);
      line-height: 1.44;
      font-weight: 500;
      transition: color 0.4s;
      text-align: center;
      max-width: 99vw;
      width: 990px;
      margin-left: auto;
      margin-right: auto;
    }
    body.light .description{color:var(--light-muted);}
    .card {
      width: 100%;
      max-width: min(100vw, 1045px);
      min-width: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01));
      border-radius: 0.77em;
      padding: 0.77em 1.54em 0.77em 1.54em;
      box-shadow: 0 7px 24px rgba(2,6,23,0.56);
      border: 1px solid rgba(255,255,255,0.07);
      position: relative;
      transition: background 0.4s, color 0.4s, max-width 0.6s, padding 0.3s;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 0.275em;
      margin: 0 auto 2.2em auto;
      max-height: 71.5vh;
      overflow: auto;
    }
    body.light .card {
      background: var(--light-panel);
      color: #1e293b;
      box-shadow: 0 6px 16px rgba(30,41,59,0.10);
      border: 1px solid #e0e7ef;
    }
    h1 {
      margin: 0 0 0.033em 0;
      font-size: 1.08em;
      font-weight: 600;
      letter-spacing: 0.12px;
      text-align: center;
      line-height: 1.12;
    }
    p.lead {
      margin: 0.1em 0 0.52em 0;
      color: var(--muted);
      font-size: 0.96em;
      transition: color 0.4s;
      text-align: center;
    }
    body.light p.lead{color:var(--light-muted);}
    .controls {
      display: flex;
      gap: 0.33em;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 0.45em;
      justify-content: center;
    }
    button {
      background: linear-gradient(180deg,#143a5f,#0f2a45);
      color: #e8f4ff;
      border: none;
      padding: 0.42em 0.74em;
      border-radius: 0.65em;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(4,10,20,0.23);
      transition: box-shadow .2s, transform .15s, background .4s, color .4s;
      font-size: 1em;
      min-width: 1.85em;
      min-height: 1.32em;
      line-height: 1.16;
      display: flex;
      align-items: center;
      gap: 0.143em;
    }
    button.ghost { background: transparent; border:1px solid rgba(255,255,255,0.07); color:var(--muted);}
    button:disabled { opacity:0.45; cursor:not-allowed; transform:none; box-shadow:none; }
    button:hover:not(:disabled) { box-shadow: 0 3px 11px #60a5fa33; transform: translateY(-1px) scale(1.035);}
    body.light button { background: linear-gradient(180deg,#c7dffe,#e0e7ef); color: #2563eb;}
    body.light button.ghost {color:var(--light-muted); border:1px solid #e0e7ef;}
    #shareBtn .share-icon {
      font-size:1.07em;
      margin-right:0.1em;
      pointer-events:none;
      vertical-align:-2px;
    }
    .result {
      display: flex;
      flex-direction: row;
      gap: 0.77em;
      align-items: flex-start;
      width: 100%;
      margin-top: 0.066em;
      justify-content: center;
    }
    .left { min-width:0; flex:1; }
    #freq { font-size: 1.13em; font-weight: 700; color: var(--accent); transition: color 0.4s; text-align: center;}
    body.light #freq{color:var(--light-accent);}
    #status { font-size: 1.13em; font-weight: 700; margin-top: 0.088em; text-align: center;}
    #comment { color: var(--muted); margin-top: 0.077em; max-width: 98%; transition: color 0.4s; text-align: center;}
    body.light #comment{color:var(--light-muted);}
    .bar { width: 100%; height: 0.429em; background: #0b1220; border-radius: 0.35em; overflow: hidden; margin: 0.121em 0 0.022em 0; border: 1px solid rgba(255,255,255,0.03);}
    .barFill { height:100%; width:0%; background:linear-gradient(90deg,#6ee7b7,#60a5fa); transition:width 500ms cubic-bezier(.7,0,.5,1);}
    body.light .bar{background:#e0e7ef;}
    body.light .barFill{background:linear-gradient(90deg,#93c5fd,#2563eb);}
    .meta { color:var(--muted); font-size:0.85em; margin:0.055em 0 0 0; text-align: center;}
    body.light .meta{color:var(--light-muted);}
    .small { font-size:0.80em; color:var(--muted); }
    body.light .small{color:var(--light-muted);}
    .countdown {
      display:inline-block;
      min-width:1.76em;
      padding:0.143em 0.24em;
      text-align:center;
      border-radius:0.5em;
      background:var(--glass);
      color:var(--muted);
      font-weight:600;
      font-size:0.92em;
      transition:color 0.4s, background 0.4s;
      margin-left: 0.25em;
    }
    body.light .countdown{color:var(--light-muted);background:#e0e7efbb;}
    #themeToggle, #langToggle, #shareBtn {font-size:1em;}
    #voiceInfo{font-size:0.92em; margin-top:0.099em; text-align: center;}
    #voiceInfo b{font-weight:600;}
    #pitchChart,#waveform {
      width:100%; max-width:396px; height:36.3px; margin:0.11em auto 0 auto; border-radius:0.5em; background:#19202f; display:none;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    body.light #pitchChart,body.light #waveform{background:#e0e7ef;}
    #statBlock{margin-top:0.143em; font-size:0.95em; color:var(--muted); text-align: center;}
    #statBlock b{color:#eab308;}
    body.light #statBlock{color:var(--light-muted);}
    .icon {font-size:1.14em;vertical-align:middle;}
    .mascot {font-size:1.17em;vertical-align:-4px;margin-left:0.3em;}
    .features { margin-top:0.10em; display:flex; gap:0.143em; flex-wrap:wrap; justify-content:center; }
    .feat { background: rgba(255,255,255,0.02); padding:0.12em 0.25em; border-radius:0.32em; color:var(--muted); font-size:0.92em; border:1px solid rgba(255,255,255,0.025); min-width:59px; text-align:center; margin-bottom:2px;}
    @media (max-width:1100px){
      .card{max-width:99vw;}
      .description{width:97vw;}
      .result{gap:0.44em;}
      #pitchChart,#waveform{max-width:93vw;}
    }
    @media (max-width:850px){
      .card{max-width:99vw;}
      .description{width:97vw;}
      .result{flex-direction:column; gap:0.24em;}
      #pitchChart,#waveform{max-width:97vw;}
    }
    @media (max-width:600px){
      body{font-size:13.5px;}
      .card{max-width:99vw;padding:0.34em;}
      .description{font-size:0.97em;width:99vw;}
      .header-controls{top:0.1em;right:0;}
      #pitchChart,#waveform{max-width:95vw;}
    }
  </style>
</head>
<body>
  <div class="header-controls">
    <button id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É" aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô</button>
    <button id="langToggle" title="Change language" aria-label="Change language">üá∑üá∫</button>
  </div>
  <div id="desc" class="description">
    Speak out loud for a few seconds and find out how brutal your voice is: Chad, Voicecel, or somewhere in between. The result is captured instantly, and a visual scale shows your voice ‚Äî simple, fun, and engaging.
  </div>
  <div class="card">
    <h1><span id="appTitle">–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å –ì–∏–≥–∞—á–∞–¥–∞</span></h1>
    <p class="lead" id="leadText">–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª, –≥–æ–≤–æ—Ä–∏ –≤—Å–ª—É—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ ‚Äî —Å–∞–π—Ç —Å–æ–±–µ—Ä—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞–Ω–∏–π, –ø–æ–¥–æ–∂–¥—ë—Ç –ø–∞—É–∑—É –∏ <b>–∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç</b> —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–Ω–∏–∑—É.</p>
    <div class="controls">
      <button id="startBtn">üé§ <span id="btnStartLabel">–ù–∞—á–∞—Ç—å</span></button>
      <button id="stopBtn" class="ghost" disabled>‚ñ† <span id="btnStopLabel">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span></button>
      <button id="resetBtn" class="ghost" disabled>‚Ü∫ <span id="btnResetLabel">–°–±—Ä–æ—Å</span></button>
      <button id="shareBtn" class="ghost" style="margin-left:.18em;display:none;"><span class="share-icon">üîó</span><span id="shareBtnTxt">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span></button>
      <div class="small" id="recStateLabel" style="margin-left:auto;">–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏: <span id="recState">–û–∂–∏–¥–∞–Ω–∏–µ</span></div>
      <div class="countdown" id="countdown" style="display:none">0.0s</div>
    </div>
    <div class="result">
      <div class="left">
        <div id="freq">–ß–∞—Å—Ç–æ—Ç–∞: ‚Äì Hz</div>
        <div id="status">–ñ–¥—É –≤–≤–æ–¥–∞... <span id="mascot"></span></div>
        <div id="comment">–°–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –≥—Ä–æ–º—á–µ –∏ –¥–µ—Ä–∂–∏ –ø–∞—É–∑—É, —á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª—Å—è.</div>
        <div class="bar"><div id="barFill" class="barFill"></div></div>
        <div class="meta" id="meta">–î–∏–∞–ø–∞–∑–æ–Ω –≥–æ–ª–æ—Å–æ–≤: 50‚Äì300 Hz ‚Ä¢ –ü–æ—Ä–æ–≥ —à—É–º–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω</div>
        <div id="voiceInfo"></div>
        <canvas id="pitchChart" width="396" height="36"></canvas>
        <canvas id="waveform" width="396" height="36"></canvas>
        <div id="statBlock"></div>
        <div class="features" aria-hidden="true"></div>
      </div>
    </div>
  </div>
  <audio id="sound-start" src="https://cdn.jsdelivr.net/gh/evyce/gigachad-detector/assets/start.mp3" preload="auto"></audio>
  <audio id="sound-stop" src="https://cdn.jsdelivr.net/gh/evyce/gigachad-detector/assets/stop.mp3" preload="auto"></audio>
  <audio id="sound-ok" src="https://cdn.jsdelivr.net/gh/evyce/gigachad-detector/assets/success.mp3" preload="auto"></audio>
  <script src="https://cdn.jsdelivr.net/npm/pitchfinder@1.2.0/dist/pitchfinder.min.js"></script>
  <script>
    // JS –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å –ø—Ä–µ–∂–Ω–∏–º–∏ –≤–µ—Ä—Å–∏—è–º–∏!
    // (–∫–æ–ø–∏—è –ø–æ–ª–Ω–æ–≥–æ JS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –≤ —Ç.—á. –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç)
    // ... (—Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç - JS –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–æ—Ç –∂–µ)
    // START JS
const i18n = {
  ru: {
    appTitle: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å –ì–∏–≥–∞—á–∞–¥–∞",
    description: "–ì–æ–≤–æ—Ä–∏ –≤—Å–ª—É—Ö –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –∏ —É–∑–Ω–∞–π, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç–≤–æ–π –≥–æ–ª–æ—Å –±—Ä—É—Ç–∞–ª—å–Ω—ã–π: –ß–∞–¥, –í–æ–π—Å—Ü–µ–ª –∏–ª–∏ —á—Ç–æ-—Ç–æ –º–µ–∂–¥—É. –†–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –∞ –Ω–∞–≥–ª—è–¥–Ω–∞—è —à–∫–∞–ª–∞ –ø–æ–∫–∞–∂–µ—Ç —Ç–≤–æ–π –≥–æ–ª–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ.",
    leadText: "–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª, –≥–æ–≤–æ—Ä–∏ –≤—Å–ª—É—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ ‚Äî —Å–∞–π—Ç —Å–æ–±–µ—Ä—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞–Ω–∏–π, –ø–æ–¥–æ–∂–¥—ë—Ç –ø–∞—É–∑—É –∏ <b>–∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç</b> —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–Ω–∏–∑—É.",
    btnStartLabel: "–ù–∞—á–∞—Ç—å",
    btnStopLabel: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
    btnResetLabel: "–°–±—Ä–æ—Å",
    btnShareLabel: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
    btnShareCopied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
    btnShareError: "–û—à–∏–±–∫–∞!",
    recStateLabel: "–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏:",
    freq: "–ß–∞—Å—Ç–æ—Ç–∞",
    waiting: "–ñ–¥—É –≤–≤–æ–¥–∞...",
    saySomething: "–°–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –≥—Ä–æ–º—á–µ –∏ –¥–µ—Ä–∂–∏ –ø–∞—É–∑—É, —á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª—Å—è.",
    analyzing: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...",
    keepTalking: "–ü—Ä–æ–¥–æ–ª–∂–∞–π –≥–æ–≤–æ—Ä–∏—Ç—å –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ, –∑–∞—Ç–µ–º —Å–¥–µ–ª–∞–π –ø–∞—É–∑—É ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è.",
    notDetected: "–ù–µ —É–¥–∞–ª–æ—Å—å",
    notDetectedComment: "–ì—Ä–æ–º–∫–æ—Å—Ç—å/—á–∏—Å—Ç–æ—Ç–∞ —Å–∏–≥–Ω–∞–ª–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
    samples: "—Å—ç–º–ø–ª–∞",
    pitchRange: "–î–∏–∞–ø–∞–∑–æ–Ω —á–∞—Å—Ç–æ—Ç",
    avgRms: "–°—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å (RMS)",
    localStats: "–õ–æ–∫–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
    median: "–ú–µ–¥–∏–∞–Ω–∞",
    best: "–õ—É—á—à–∏–π",
    graphPitch: "–ì—Ä–∞—Ñ–∏–∫ —á–∞—Å—Ç–æ—Ç—ã",
    graphWave: "–í–æ–ª–Ω–∞",
    categories: [
      { label: "–≥–ª—É–±–æ–∫–∏–π –≥–æ–ª–æ—Å –ß–∞–¥–∞", icon: "üí™", range: "–¥–æ 90 –ì—Ü", from: 0, to: 90 },
      { label: "–ß–∞–¥", icon: "üï∂Ô∏è", range: "–æ—Ç 90 –¥–æ 110 –ì—Ü", from: 90, to: 110 },
      { label: "–í–æ–π—Å—Ü–µ–ª", icon: "üòê", range: "–æ—Ç 110 –¥–æ 140 –ì—Ü", from: 110, to: 140 },
      { label: "–í–æ–π—Å—Ü–µ–ª. –í—Å—ë –∫–æ–Ω—á–µ–Ω–æ.", icon: "ü§°", range: "–±–æ–ª–µ–µ 155 –ì—Ü", from: 155, to: 1000 }
    ]
  },
  en: {
    appTitle: "GigaChad Voice Detector",
    description: "Speak out loud for a few seconds and find out how brutal your voice is: Chad, Voicecel, or somewhere in between. The result is captured instantly, and a visual scale shows your voice ‚Äî simple, fun, and engaging.",
    leadText: "Press 'Start', speak for a few seconds ‚Äî the site will collect readings, wait for a pause and <b>lock in</b> the result below.",
    btnStartLabel: "Start",
    btnStopLabel: "Stop",
    btnResetLabel: "Reset",
    btnShareLabel: "Share",
    btnShareCopied: "Copied!",
    btnShareError: "Error!",
    recStateLabel: "Recording state:",
    freq: "Pitch",
    waiting: "Waiting for input...",
    saySomething: "Say something louder and pause to lock in the result.",
    analyzing: "Analyzing...",
    keepTalking: "Keep speaking for a bit, then pause ‚Äî the result will be fixed.",
    notDetected: "Not detected",
    notDetectedComment: "Volume/clarity too low ‚Äî try again.",
    samples: "samples",
    pitchRange: "Pitch range",
    avgRms: "Avg. loudness (RMS)",
    localStats: "Local stats",
    median: "Median",
    best: "Best",
    graphPitch: "Pitch chart",
    graphWave: "Waveform",
    categories: [
      { label: "Deep Chad Voice", icon: "üí™", range: "Up to 90 Hz", from: 0, to: 90 },
      { label: "Chad", icon: "üï∂Ô∏è", range: "90‚Äì110 Hz", from: 90, to: 110 },
      { label: "Voicecel", icon: "üòê", range: "110‚Äì140 Hz", from: 110, to: 140 },
      { label: "Voicecel. It's over", icon: "ü§°", range: "Above 155 Hz", from: 155, to: 1000 }
    ]
  }
};
let lang = (window.localStorage && localStorage.getItem("lang")) || (navigator.language||"").startsWith("en") ? "en":"ru";
function setLang(l) {
  lang = l;
  if(window.localStorage) localStorage.setItem("lang",l);
  const t = i18n[l];
  document.getElementById('appTitle').textContent = t.appTitle;
  document.getElementById('desc').textContent = t.description;
  document.getElementById('leadText').innerHTML = t.leadText;
  document.getElementById('btnStartLabel').textContent = t.btnStartLabel;
  document.getElementById('btnStopLabel').textContent = t.btnStopLabel;
  document.getElementById('btnResetLabel').textContent = t.btnResetLabel;
  document.getElementById('shareBtnTxt').textContent = t.btnShareLabel;
  document.getElementById('recStateLabel').childNodes[0].textContent = t.recStateLabel+" ";
  document.getElementById('freq').textContent = t.freq+": ‚Äì Hz";
  document.getElementById('status').textContent = t.waiting;
  document.getElementById('comment').textContent = t.saySomething;
  document.getElementById('langToggle').textContent = l==="en"?"üá∫üá∏":"üá∑üá∫";
}
document.addEventListener('DOMContentLoaded',()=>setLang(lang));
document.getElementById('langToggle').onclick = () => setLang(lang==="ru"?"en":"ru");

function setTheme(dark) {
  document.body.classList.toggle('light', !dark);
  if(window.localStorage) localStorage.setItem("theme",dark?"dark":"light");
  document.getElementById('themeToggle').textContent = dark ? "üåô" : "‚òÄÔ∏è";
}
let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
let savedTheme = (window.localStorage && localStorage.getItem("theme")) || (prefersDark ? "dark" : "light");
setTheme(savedTheme==="dark");
document.getElementById('themeToggle').onclick = () => setTheme(document.body.classList.contains('light'));

function playSound(id) {
  const a = document.getElementById(id);
  if(a) { a.currentTime=0; a.play(); }
}

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const shareBtn = document.getElementById('shareBtn');

const freqEl = document.getElementById('freq');
const statusEl = document.getElementById('status');
const mascotEl = document.getElementById('mascot');
const commentEl = document.getElementById('comment');
const barFill = document.getElementById('barFill');
const recState = document.getElementById('recState');
const countdownEl = document.getElementById('countdown');
const voiceInfo = document.getElementById('voiceInfo');
const pitchChart = document.getElementById('pitchChart');
const waveformCanvas = document.getElementById('waveform');
const statBlock = document.getElementById('statBlock');

let audioCtx = null, analyser = null, sourceNode = null, mediaStream = null, rafId = null;
const FFT_SIZE = 2048, MIN_FREQ = 50, MAX_FREQ = 300, RMS_THRESHOLD = 0.03, CLARITY_THRESHOLD = 0.08;
const minSpeakMs = 1500, silenceHoldMs = 700;

let collected = [], collectedRms = [], speakingSince = 0, lastActive = 0, locked = false, running = false;
let pfDetector = null, lastResult = null, lastShareString = null;

function detectPitch(buf, sampleRate){
  const SIZE = buf.length;
  let sumSq = 0;
  for(let i=0;i<SIZE;i++) sumSq+=buf[i]*buf[i];
  const rms=Math.sqrt(sumSq/SIZE);
  if(rms<RMS_THRESHOLD) return {freq:-1, clarity:0, rms};

  let pfFreq=null;
  try{ if(pfDetector) pfFreq=pfDetector(buf); if(pfFreq && (pfFreq<MIN_FREQ || pfFreq>MAX_FREQ)) pfFreq=null; } catch(e){ pfFreq=null; }

  const minLag=Math.floor(sampleRate/MAX_FREQ);
  const maxLag=Math.min(Math.floor(sampleRate/MIN_FREQ), SIZE-2);
  const c=new Float32Array(maxLag-minLag+1);
  for(let lag=minLag;lag<=maxLag;lag++){ let s=0; for(let i=0;i<SIZE-lag;i++) s+=buf[i]*buf[i+lag]; c[lag-minLag]=s; }

  let bestIdx=0,bestVal=-Infinity;
  for(let i=0;i<c.length;i++){ if(c[i]>bestVal){ bestVal=c[i]; bestIdx=i; } }
  if(bestVal<=0||sumSq<=0) return {freq:-1,clarity:0,rms};

  const clarity=Math.max(0,Math.min(1,bestVal/sumSq));
  if(clarity<CLARITY_THRESHOLD && !pfFreq) return {freq:-1,clarity,rms};

  const k=bestIdx,kGlobal=k+minLag;
  let refined=kGlobal;
  if(k>0 && k<c.length-1){ const y1=c[k-1],y2=c[k],y3=c[k+1],denom=(y1-2*y2+y3); if(denom!==0) refined=kGlobal+0.5*(y1-y3)/denom; }

  if(pfFreq && clarity>=CLARITY_THRESHOLD) return {freq:pfFreq,clarity,rms};
  return {freq:sampleRate/refined,clarity,rms};
}

function classify(freq){
  const cats = i18n[lang].categories;
  if(freq<0) return {label:cats[0].label, comment:i18n[lang].notDetectedComment, icon:cats[0].icon};
  if(freq<=cats[0].to) return {label:cats[0].label, comment:lang==="ru"?"–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π, –±—Ä—É—Ç–∞–ª—å–Ω—ã–π —Ç–µ–º–±—Ä.":"Very low, brutal timbre.", icon:cats[0].icon};
  if(freq<=cats[1].to) return {label:cats[1].label, comment:lang==="ru"?"–ù–∏–∑–∫–∏–π –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–π –≥–æ–ª–æ—Å.":"Low, confident voice.", icon:cats[1].icon};
  if(freq<=cats[2].to) return {label:cats[2].label, comment:lang==="ru"?"–í–æ–π—Å—Ü–µ–ª-–ø–æ–∑–∏—Ü–∏—è.":"Voicecel-tier.", icon:cats[2].icon};
  if(freq>=cats[3].from) return {label:cats[3].label, comment:lang==="ru"?"–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π –≥–æ–ª–æ—Å ‚Äî –º–µ–º–Ω–∞—è –ø–æ–º–µ—Ç–∫–∞.":"Extremely high voice ‚Äî meme status.", icon:cats[3].icon};
  return {label:cats[3].label, comment:lang==="ru"?"–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π –≥–æ–ª–æ—Å ‚Äî –º–µ–º–Ω–∞—è –ø–æ–º–µ—Ç–∫–∞.":"Extremely high voice ‚Äî meme status.", icon:cats[3].icon};
}

function setRecState(text){ recState.textContent=text; }
function setCountdown(sec){ countdownEl.style.display=sec>0?'inline-block':'none'; countdownEl.textContent=(sec/1000).toFixed(1)+'s'; }

async function startListening(){
  if(running) return;
  playSound('sound-start');
  locked=false; collected=[]; collectedRms=[]; speakingSince=0; lastActive=0;
  voiceInfo.innerHTML = '';
  statBlock.innerHTML = '';
  pitchChart.style.display='none';
  waveformCanvas.style.display='block';
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    mediaStream=await navigator.mediaDevices.getUserMedia({audio:{noiseSuppression:true,echoCancellation:true,autoGainControl:true}});
    sourceNode=audioCtx.createMediaStreamSource(mediaStream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=FFT_SIZE;
    analyser.smoothingTimeConstant=0;
    sourceNode.connect(analyser);

    const PF=window.Pitchfinder||window.PitchFinder||window.pitchfinder;
    if(PF){
      if(typeof PF.YIN==='function') pfDetector=PF.YIN({sampleRate:audioCtx.sampleRate});
      else if(typeof PF.AMDF==='function') pfDetector=PF.AMDF({sampleRate:audioCtx.sampleRate});
      else pfDetector=null;
    }

    running=true;
    startBtn.disabled=true; stopBtn.disabled=false; resetBtn.disabled=true;
    setRecState(i18n[lang].waiting);
    runLoop();
    drawWaveform();
  }catch(e){
    setRecState('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    running=false; startBtn.disabled=false; stopBtn.disabled=true;
  }
}

function stopListening(){
  playSound('sound-stop');
  if(!running) return;
  if(rafId) cancelAnimationFrame(rafId);
  try{ if(sourceNode) sourceNode.disconnect(); if(analyser) analyser.disconnect(); if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){}
  running=false; startBtn.disabled=false; stopBtn.disabled=true; resetBtn.disabled=false;
  setRecState('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'); setCountdown(0);
}

function resetAll(){
  if(running) stopListening();
  locked=false; collected=[]; collectedRms=[]; speakingSince=0; lastActive=0;
  freqEl.textContent=i18n[lang].freq+': ‚Äì Hz';
  statusEl.textContent=i18n[lang].waiting;
  mascotEl.textContent='';
  commentEl.textContent=i18n[lang].saySomething;
  barFill.style.width='0%';
  setRecState(i18n[lang].waiting); resetBtn.disabled=true; startBtn.disabled=false; setCountdown(0); lastResult=null; lastShareString=null;
  voiceInfo.innerHTML = '';
  statBlock.innerHTML = '';
  pitchChart.style.display='none';
  waveformCanvas.style.display='none';
  shareBtn.style.display="none";
}

const timeDomain=new Float32Array(FFT_SIZE);

function runLoop(){
  rafId=requestAnimationFrame(runLoop);
  if(!analyser) return;
  analyser.getFloatTimeDomainData(timeDomain);
  const det=detectPitch(timeDomain,audioCtx.sampleRate);
  const now=performance.now();

  if(det.freq>0) barFill.style.width=Math.max(0,Math.min(100,((det.freq-MIN_FREQ)/(MAX_FREQ-MIN_FREQ))*100))+'%';

  if(locked) return;
  const active=(det.rms>=RMS_THRESHOLD)&&(det.clarity>=CLARITY_THRESHOLD)&&(det.freq>=MIN_FREQ&&det.freq<=MAX_FREQ);

  if(active){
    if(speakingSince===0) speakingSince=now;
    lastActive=now;
    collected.push(det.freq);
    collectedRms.push(det.rms);
    setRecState(i18n[lang].analyzing);
    freqEl.textContent=i18n[lang].freq+': '+det.freq.toFixed(1)+' Hz';
    statusEl.textContent=i18n[lang].analyzing;
    commentEl.textContent=i18n[lang].keepTalking;
    const spoken=now-speakingSince;
    const remain=Math.max(0,minSpeakMs-spoken);
    setCountdown(remain);
  } else {
    if(speakingSince!==0){
      const spoken=lastActive-speakingSince;
      const silentFor=now-lastActive;
      setRecState(silentFor<1000?i18n[lang].analyzing:i18n[lang].waiting);
      if(spoken>=minSpeakMs && silentFor>=silenceHoldMs){ finalizeResult(); return; }
      const toLock=Math.max(0,silenceHoldMs-silentFor);
      setCountdown(spoken<minSpeakMs?Math.max(0,minSpeakMs-spoken):toLock);
    } else { setRecState(i18n[lang].waiting); setCountdown(0); }
  }
}

function drawWaveform(){
  if(!analyser||!waveformCanvas) return;
  const ctx = waveformCanvas.getContext('2d');
  const w = waveformCanvas.width, h = waveformCanvas.height;
  const data = new Float32Array(analyser.fftSize);
  function draw(){
    if(!running) return;
    analyser.getFloatTimeDomainData(data);
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle = document.body.classList.contains('light') ? "#2563eb" : "#60a5fa";
    ctx.lineWidth = 2.1;
    ctx.beginPath();
    for(let i=0;i<w;i++){
      const j = Math.floor(i/data.length*data.length);
      const y = (0.5-data[j])*h*0.8+ h/2;
      if(i===0) ctx.moveTo(i,y);
      else ctx.lineTo(i,y);
    }
    ctx.stroke();
    requestAnimationFrame(draw);
  }
  waveformCanvas.style.display='block';
  draw();
}

function finalizeResult(){
  playSound('sound-ok');
  waveformCanvas.style.display='none';
  if(collected.length===0){
    freqEl.textContent=i18n[lang].freq+': ‚Äì Hz';
    statusEl.textContent=i18n[lang].notDetected;
    mascotEl.textContent='';
    commentEl.textContent=i18n[lang].notDetectedComment;
    shareBtn.style.display="none";
    return;
  }
  const sum=collected.reduce((s,v)=>s+v,0);
  const avg=sum/collected.length;
  const cls=classify(avg);
  freqEl.textContent=i18n[lang].freq+': '+avg.toFixed(1)+' Hz';
  statusEl.textContent=cls.label;
  mascotEl.textContent=cls.icon;
  commentEl.textContent=cls.comment+' ('+i18n[lang].samples+' '+collected.length+')';
  locked=true; setRecState('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω'); setCountdown(0);
  lastResult=`${Math.round(avg)} Hz ‚Äî ${cls.label}`;
  lastShareString = `${i18n[lang].appTitle}\n${i18n[lang].freq}: ${avg.toFixed(1)} Hz\n${cls.label}\n${cls.comment}`;
  shareBtn.style.display="inline-flex";

  // –î–æ–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –¥–∏–∞–ø–∞–∑–æ–Ω, —Å—Ä–µ–¥–Ω–∏–π RMS
  const minFreq = Math.min(...collected).toFixed(1);
  const maxFreq = Math.max(...collected).toFixed(1);
  const freqRange = (maxFreq - minFreq).toFixed(1);
  const avgRms = (collectedRms.reduce((s, v) => s + v, 0) / collectedRms.length).toFixed(3);
  voiceInfo.innerHTML = `<div>${i18n[lang].pitchRange}: <b>${minFreq}‚Äì${maxFreq} Hz</b> (${freqRange} Hz)</div>
    <div>${i18n[lang].avgRms}: <b>${avgRms}</b></div>`;

  // –ì—Ä–∞—Ñ–∏–∫ —á–∞—Å—Ç–æ—Ç—ã
  pitchChart.style.display = 'block';
  const ctx = pitchChart.getContext('2d');
  ctx.clearRect(0,0,pitchChart.width,pitchChart.height);
  ctx.strokeStyle = document.body.classList.contains('light') ? "#2563eb" : "#60a5fa";
  ctx.lineWidth = 2;
  ctx.beginPath();
  collected.forEach((f, i) => {
    const x = (i / (collected.length-1)) * (pitchChart.width-8) + 4;
    const y = pitchChart.height-8 - ((f-MIN_FREQ)/(MAX_FREQ-MIN_FREQ))*(pitchChart.height-16);
    if(i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.strokeStyle = "#334155";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(4, pitchChart.height-8);
  ctx.lineTo(pitchChart.width-4, pitchChart.height-8);
  ctx.stroke();
  ctx.font = '11px Inter,sans-serif';
  ctx.fillStyle = '#9aa4b2';
  ctx.fillText(MIN_FREQ+'Hz', 4, pitchChart.height-2);
  ctx.fillText(MAX_FREQ+'Hz', pitchChart.width-36, pitchChart.height-2);

  // –õ–æ–∫–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (localStorage)
  let stats = [];
  if(window.localStorage) {
    stats = JSON.parse(localStorage.getItem("gigachad_stats")||"[]");
    stats.push(avg);
    localStorage.setItem("gigachad_stats",JSON.stringify(stats.slice(-100)));
  }
  if(stats.length>1) {
    const sorted = stats.slice().sort((a,b)=>a-b);
    const median = sorted[Math.floor(sorted.length/2)];
    const best = sorted[0];
    statBlock.innerHTML = `${i18n[lang].localStats}: ${i18n[lang].median} <b>${median.toFixed(1)} Hz</b>, ${i18n[lang].best} <b>${best.toFixed(1)} Hz</b> <br><canvas id="hist" width="200" height="32" style="margin-top:2px;border-radius:6px;background:#19202f"></canvas>`;
    // draw histogram
    const hist = document.getElementById('hist');
    const hctx = hist.getContext('2d');
    hctx.clearRect(0,0,hist.width,hist.height);
    const bins = Array(8).fill(0);
    stats.forEach(v=>{
      const idx = Math.min(7,Math.floor((v-MIN_FREQ)/(MAX_FREQ-MIN_FREQ)*8));
      bins[idx]++;
    });
    const maxBin = Math.max(...bins,1);
    for(let i=0;i<8;i++){
      hctx.fillStyle = "#60a5fa";
      hctx.fillRect(i*24+4, hist.height-5-bins[i]/maxBin*21, 15, bins[i]/maxBin*21);
      hctx.fillStyle = "#64748b";
      hctx.font = "9px Inter,sans-serif";
      hctx.fillText((MIN_FREQ + (MAX_FREQ-MIN_FREQ)/8*i).toFixed(0), i*24+4, hist.height-2);
    }
  } else {
    statBlock.innerHTML = '';
  }

  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —à–∫–∞–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–±–µ–∑ —Å—Ç—Ä–µ–ª–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∏)
  const featBlock = document.querySelector('.features');
  if (featBlock) {
    featBlock.innerHTML = '';
    const categories = i18n[lang].categories;
    const userFreq = avg;
    let userCategoryIdx = categories.findIndex(cat => userFreq >= cat.from && userFreq < cat.to || (cat.from <= userFreq && cat.to >= userFreq));
    if(userFreq>=categories[categories.length-1].from) userCategoryIdx=categories.length-1;
    categories.forEach((cat, idx) => {
      const div = document.createElement('div');
      div.className = 'feat';
      div.style.background = (idx === userCategoryIdx) ? "#2563eb" : 'rgba(255,255,255,0.05)';
      div.style.color = (idx === userCategoryIdx) ? '#fff' : 'var(--muted)';
      div.style.fontWeight = (idx === userCategoryIdx) ? 'bold' : 'normal';
      div.style.border = (idx === userCategoryIdx) ? '2px solid #fff' : '1px solid rgba(255,255,255,0.07)';
      div.innerHTML = `<span class="icon">${cat.icon}</span> <span style="font-size:1em">${cat.label}</span><br><span style="font-size:0.92em">${cat.range}</span>`;
      featBlock.appendChild(div);
    });
  }
  shareBtn.style.display = "inline-flex";
}

startBtn.addEventListener('click',()=>{ resetAll(); startListening(); });
stopBtn.addEventListener('click',()=>{ stopListening(); });
resetBtn.addEventListener('click',()=>{ resetAll(); });

shareBtn.addEventListener('click', async ()=>{
  if(!lastShareString) return;
  let text = lastShareString + "\n" + window.location.href;
  if(navigator.share){
    try{
      await navigator.share({title:i18n[lang].appTitle,text:lastShareString,url:window.location.href});
      return;
    }catch(e){}
  }
  try {
    await navigator.clipboard.writeText(text);
    const old = shareBtn.querySelector("#shareBtnTxt").textContent;
    shareBtn.querySelector("#shareBtnTxt").textContent = i18n[lang].btnShareCopied;
    setTimeout(()=>{shareBtn.querySelector("#shareBtnTxt").textContent = i18n[lang].btnShareLabel;}, 1400);
  } catch(e){
    shareBtn.querySelector("#shareBtnTxt").textContent = i18n[lang].btnShareError;
    setTimeout(()=>{shareBtn.querySelector("#shareBtnTxt").textContent = i18n[lang].btnShareLabel;}, 1600);
  }
});

window.addEventListener('beforeunload',()=>{
  try{ if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); if(audioCtx && audioCtx.close) audioCtx.close(); }catch(e){}
});

resetAll();
  </script>
</body>
</html>